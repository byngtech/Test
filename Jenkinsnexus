pipeline {
    agent any
    
    parameters {
        string(name: 'SOURCE_NEXUS_URL', defaultValue: 'https://source-nexus.example.com', description: 'Source Nexus URL')
        string(name: 'TARGET_NEXUS_URL', defaultValue: 'https://target-nexus.example.com', description: 'Target Nexus URL')
        string(name: 'SOURCE_REPO', defaultValue: 'maven-releases', description: 'Source repository name')
        string(name: 'TARGET_REPO', defaultValue: 'maven-releases', description: 'Target repository name')
        credentials(name: 'SOURCE_CREDENTIALS', description: 'Source Nexus credentials', credentialType: 'Username with password', required: true)
        credentials(name: 'TARGET_CREDENTIALS', description: 'Target Nexus credentials', credentialType: 'Username with password', required: true)
        text(name: 'ARTIFACT_LIST', defaultValue: '', description: 'List of artifacts to migrate (one per line): groupId:artifactId:version')
        booleanParam(name: 'DRY_RUN', defaultValue: true, description: 'Dry run mode - only show what would be migrated')
        choice(name: 'BATCH_SIZE', choices: ['10', '25', '50', '100'], description: 'Number of artifacts to process in parallel')
    }
    
    environment {
        WORK_DIR = "${WORKSPACE}/nexus-migration"
        MAVEN_OPTS = "-Xmx2g"
    }
    
    tools {
        maven 'Maven 3.9.0' // Adjust to match your Jenkins Maven installation name
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "Starting Nexus migration using Maven..."
                    echo "Source: ${params.SOURCE_NEXUS_URL}/repository/${params.SOURCE_REPO}"
                    echo "Target: ${params.TARGET_NEXUS_URL}/repository/${params.TARGET_REPO}"
                    echo "Dry Run: ${params.DRY_RUN}"
                    
                    sh """
                        mkdir -p ${WORK_DIR}
                        rm -rf ${WORK_DIR}/*
                    """
                    
                    // Parse artifact list
                    def artifacts = params.ARTIFACT_LIST.trim().split('\n').findAll { it.trim() }
                    if (artifacts.isEmpty()) {
                        error("No artifacts specified. Please provide a list of artifacts in format: groupId:artifactId:version")
                    }
                    
                    echo "Total artifacts to migrate: ${artifacts.size()}"
                    writeFile file: "${WORK_DIR}/artifacts.txt", text: artifacts.join('\n')
                    
                    // Create Maven settings.xml with both source and target repositories
                    withCredentials([
                        usernamePassword(credentialsId: params.SOURCE_CREDENTIALS, 
                                       usernameVariable: 'SRC_USER', 
                                       passwordVariable: 'SRC_PASS'),
                        usernamePassword(credentialsId: params.TARGET_CREDENTIALS, 
                                       usernameVariable: 'TGT_USER', 
                                       passwordVariable: 'TGT_PASS')
                    ]) {
                        writeFile file: "${WORK_DIR}/settings.xml", text: """
<?xml version="1.0" encoding="UTF-8"?>
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                              http://maven.apache.org/xsd/settings-1.0.0.xsd">
    <servers>
        <server>
            <id>source-nexus</id>
            <username>${SRC_USER}</username>
            <password>${SRC_PASS}</password>
        </server>
        <server>
            <id>target-nexus</id>
            <username>${TGT_USER}</username>
            <password>${TGT_PASS}</password>
        </server>
    </servers>
    <profiles>
        <profile>
            <id>nexus-migration</id>
            <repositories>
                <repository>
                    <id>source-nexus</id>
                    <url>${params.SOURCE_NEXUS_URL}/repository/${params.SOURCE_REPO}</url>
                    <releases>
                        <enabled>true</enabled>
                    </releases>
                    <snapshots>
                        <enabled>true</enabled>
                    </snapshots>
                </repository>
            </repositories>
        </profile>
    </profiles>
    <activeProfiles>
        <activeProfile>nexus-migration</activeProfile>
    </activeProfiles>
</settings>
"""
                    }
                }
            }
        }
        
        stage('Migrate Artifacts') {
            steps {
                script {
                    def artifactList = readFile("${WORK_DIR}/artifacts.txt").trim().split('\n')
                    def successCount = 0
                    def failureCount = 0
                    def failures = []
                    
                    artifactList.eachWithIndex { artifact, idx ->
                        def parts = artifact.trim().split(':')
                        if (parts.size() < 3) {
                            echo "ERROR: Invalid artifact format: ${artifact} (expected groupId:artifactId:version)"
                            failureCount++
                            failures << artifact
                            return
                        }
                        
                        def groupId = parts[0]
                        def artifactId = parts[1]
                        def version = parts[2]
                        def packaging = parts.size() > 3 ? parts[3] : 'jar'
                        def classifier = parts.size() > 4 ? parts[4] : ''
                        
                        echo "\n[${idx + 1}/${artifactList.size()}] Processing: ${groupId}:${artifactId}:${version}${classifier ? ':' + classifier : ''}"
                        
                        if (params.DRY_RUN) {
                            echo "  DRY RUN - Would download from source and deploy to target"
                            successCount++
                        } else {
                            try {
                                def artifactDir = "${WORK_DIR}/${groupId}/${artifactId}/${version}"
                                sh "mkdir -p ${artifactDir}"
                                
                                // Download artifact from source using Maven dependency plugin
                                echo "  Downloading from source repository..."
                                def downloadCmd = """
                                    cd ${artifactDir} && \
                                    mvn -s ${WORK_DIR}/settings.xml \
                                        org.apache.maven.plugins:maven-dependency-plugin:3.6.0:copy \
                                        -Dartifact=${groupId}:${artifactId}:${version}:${packaging}${classifier ? ':' + classifier : ''} \
                                        -DoutputDirectory=. \
                                        -Dmdep.useBaseVersion=true
                                """
                                
                                def downloadResult = sh(script: downloadCmd, returnStatus: true)
                                
                                if (downloadResult != 0) {
                                    echo "  WARNING: Main artifact download failed, trying without classifier..."
                                    downloadCmd = """
                                        cd ${artifactDir} && \
                                        mvn -s ${WORK_DIR}/settings.xml \
                                            org.apache.maven.plugins:maven-dependency-plugin:3.6.0:copy \
                                            -Dartifact=${groupId}:${artifactId}:${version}:pom \
                                            -DoutputDirectory=. \
                                            -Dmdep.useBaseVersion=true
                                    """
                                    sh downloadCmd
                                }
                                
                                // Try to download POM separately
                                sh """
                                    cd ${artifactDir} && \
                                    mvn -s ${WORK_DIR}/settings.xml \
                                        org.apache.maven.plugins:maven-dependency-plugin:3.6.0:copy \
                                        -Dartifact=${groupId}:${artifactId}:${version}:pom \
                                        -DoutputDirectory=. \
                                        -Dmdep.useBaseVersion=true || echo "POM already exists or not available"
                                """
                                
                                // Try to download sources
                                sh """
                                    cd ${artifactDir} && \
                                    mvn -s ${WORK_DIR}/settings.xml \
                                        org.apache.maven.plugins:maven-dependency-plugin:3.6.0:copy \
                                        -Dartifact=${groupId}:${artifactId}:${version}:jar:sources \
                                        -DoutputDirectory=. \
                                        -Dmdep.useBaseVersion=true || echo "Sources not available"
                                """
                                
                                // Try to download javadoc
                                sh """
                                    cd ${artifactDir} && \
                                    mvn -s ${WORK_DIR}/settings.xml \
                                        org.apache.maven.plugins:maven-dependency-plugin:3.6.0:copy \
                                        -Dartifact=${groupId}:${artifactId}:${version}:jar:javadoc \
                                        -DoutputDirectory=. \
                                        -Dmdep.useBaseVersion=true || echo "Javadoc not available"
                                """
                                
                                // Find downloaded files
                                def files = sh(script: "ls ${artifactDir}/*.* 2>/dev/null || true", returnStdout: true).trim().split('\n')
                                
                                if (!files || files[0] == '') {
                                    throw new Exception("No files downloaded")
                                }
                                
                                echo "  Downloaded ${files.size()} file(s)"
                                
                                // Find main artifact and POM
                                def mainFile = files.find { it.endsWith(".${packaging}") && !it.contains('-sources.') && !it.contains('-javadoc.') }
                                def pomFile = files.find { it.endsWith('.pom') }
                                def sourcesFile = files.find { it.contains('-sources.jar') }
                                def javadocFile = files.find { it.contains('-javadoc.jar') }
                                
                                // Deploy to target repository
                                echo "  Deploying to target repository..."
                                
                                if (mainFile && pomFile) {
                                    def deployCmd = """
                                        mvn -s ${WORK_DIR}/settings.xml \
                                            deploy:deploy-file \
                                            -DgroupId=${groupId} \
                                            -DartifactId=${artifactId} \
                                            -Dversion=${version} \
                                            -Dpackaging=${packaging} \
                                            -Dfile=${mainFile} \
                                            -DpomFile=${pomFile} \
                                            -DrepositoryId=target-nexus \
                                            -Durl=${params.TARGET_NEXUS_URL}/repository/${params.TARGET_REPO}
                                    """
                                    
                                    if (sourcesFile) {
                                        deployCmd += " -Dsources=${sourcesFile}"
                                    }
                                    
                                    if (javadocFile) {
                                        deployCmd += " -Djavadoc=${javadocFile}"
                                    }
                                    
                                    sh deployCmd
                                    
                                } else if (pomFile && !mainFile) {
                                    // POM-only artifact (parent POM)
                                    sh """
                                        mvn -s ${WORK_DIR}/settings.xml \
                                            deploy:deploy-file \
                                            -DgroupId=${groupId} \
                                            -DartifactId=${artifactId} \
                                            -Dversion=${version} \
                                            -Dpackaging=pom \
                                            -Dfile=${pomFile} \
                                            -DrepositoryId=target-nexus \
                                            -Durl=${params.TARGET_NEXUS_URL}/repository/${params.TARGET_REPO}
                                    """
                                } else {
                                    throw new Exception("No suitable files found for deployment")
                                }
                                
                                echo "  ✓ Successfully migrated"
                                successCount++
                                
                                // Clean up
                                sh "rm -rf ${artifactDir}"
                                
                            } catch (Exception e) {
                                echo "  ✗ ERROR: ${e.message}"
                                failureCount++
                                failures << artifact
                            }
                        }
                    }
                    
                    echo "\n" + "=".multiply(70)
                    echo "Migration Summary:"
                    echo "  Total artifacts: ${artifactList.size()}"
                    echo "  Successful: ${successCount}"
                    echo "  Failed: ${failureCount}"
                    
                    if (failureCount > 0) {
                        echo "\nFailed artifacts:"
                        failures.each { echo "  - ${it}" }
                    }
                    echo "=".multiply(70)
                    
                    if (failureCount > 0 && !params.DRY_RUN) {
                        error("Migration completed with ${failureCount} failures")
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Cleaning up workspace..."
                sh "rm -rf ${WORK_DIR}"
            }
        }
        success {
            echo "Migration completed successfully!"
        }
        failure {
            echo "Migration failed. Please check the logs above for details."
        }
    }
}
